<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីបង្កើតគណនី</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js for face recognition -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Google Fonts for a Khmer font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #cameraModal {
            background-color: rgba(0, 0, 0, 0.6);
        }
        /* Circular video preview styles */
        #videoContainer {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            background-color: #000;
            transform: scaleX(-1); /* Mirror the video feed */
        }
        #video, #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
        }
        #scannerEffect {
            --scanner-color: #3b82f6;
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(
                from 180deg at 50% 50%,
                rgba(59, 130, 246, 0) 0%,
                var(--scanner-color) 50%,
                rgba(59, 130, 246, 0) 100%
            );
            animation: scanner-spin 2s linear infinite;
        }
        @keyframes scanner-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Laser Scanner Styles */
        #laserScanner {
            position: absolute;
            inset: 0.5rem; /* Matches parent's p-2 padding */
            border-radius: 50%;
            overflow: hidden;
            pointer-events: none; /* Let clicks pass through */
            z-index: 2;
        }

        #laserScanner::after {
            content: '';
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.8), 0 0 10px rgba(59, 130, 246, 0.8), 0 0 15px rgba(255, 255, 255, 0.8);
            animation: laser-scan-line 2.5s ease-in-out infinite;
        }

        @keyframes laser-scan-line {
            0% {
                left: 15%;
            }
            50% {
                left: 85%;
            }
            100% {
                left: 15%;
            }
        }
    </style>
</head>
<!-- MODIFICATION: Adjusted body classes for better mobile layout handling -->
<body class="bg-gray-100 flex justify-center min-h-screen p-4 sm:p-0 sm:items-center">

    <!-- Login Form Container (Initially Hidden) -->
    <div id="appContainer" class="w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-6 hidden">
        <!-- MODIFICATION: Removed unnecessary helper class -->
        <div id="formHeader" class="text-center">
            <h1 class="text-2xl font-bold text-gray-800">ទម្រង់ចូលគណនី</h1>
            <p class="text-gray-500 mt-2">សូមជ្រើសរើសព័ត៌មានរបស់អ្នក</p>
        </div>

        <!-- Form Content -->
        <form id="accountForm" class="space-y-6">
            <!-- Class Input -->
            <!-- MODIFICATION: Removed unnecessary helper class -->
            <div id="classInputContainer">
                <label for="classInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើស ឬវាយបញ្ចូលថ្នាក់រៀន</label>
                <input list="classList" id="classInput" name="classInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                <datalist id="classList"></datalist>
            </div>

            <!-- ID Input -->
            <!-- MODIFICATION: Removed unnecessary helper class -->
            <div id="idInputContainer">
                <label for="idInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើស ឬវាយបញ្ចូលអត្តលេខ</label>
                <input list="idList" id="idInput" name="idInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off" disabled>
                <datalist id="idList"></datalist>
            </div>

            <!-- Name Display -->
            <!-- MODIFICATION: Removed unnecessary helper class -->
            <div id="nameDisplayContainer" class="bg-gray-50 p-4 rounded-md text-center">
                <label class="text-sm font-medium text-gray-500">ឈ្មោះសិស្ស</label>
                <p id="nameDisplay" class="text-xl font-bold text-indigo-600 mt-1">-</p>
            </div>
        </form>
         <div id="errorContainer" class="text-center hidden">
             <p id="errorMessage" class="text-red-500"></p>
             <button id="retryButton" class="mt-4 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">ព្យាយាមម្ដងទៀត</button>
         </div>
    </div>
    
    <!-- Loading Indicator (Visible at start) -->
    <div id="loader" class="flex flex-col items-center justify-center space-y-2">
        <div class="loader"></div>
        <p class="text-gray-500">កំពុងตรวจสอบ...</p>
    </div>

    <!-- Home Page UI (Initially Hidden) -->
    <div id="homePage" class="w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-6 text-center hidden">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h1 class="text-2xl font-bold text-gray-800">ការចូលជោគជ័យ!</h1>
        <p class="text-gray-600 text-lg">សូមស្វាគមន៍, <span id="homeName" class="font-bold"></span>!</p>
        <!-- NEW Logout Button -->
        <button id="logoutButton" class="mt-4 bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600 transition-colors">ចាកចេញ</button>
    </div>


    <!-- Camera Verification Modal -->
    <div id="cameraModal" class="fixed inset-0 w-full h-full flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
            <h2 class="text-xl font-bold mb-4">សូមដាក់មុខនៅចំកណ្តាល</h2>
            <div class="relative w-64 h-64 mx-auto mb-4 p-2">
                <div id="scannerEffect"></div>
                <div id="laserScanner"></div>
                <div id="videoContainer">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
            </div>
            <p id="cameraStatus" class="text-gray-600 mb-4 h-6">កំពុងចាប់ផ្តើមកាមេរ៉ា...</p>
            <button id="closeModalButton" class="bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600">បោះបង់</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- Configuration ---
            const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
            const SHEET_NAME = 'DIList';
            const RANGE = 'E9:AA';
            const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';

            // --- DOM Elements ---
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');
            const accountForm = document.getElementById('accountForm');
            const classInput = document.getElementById('classInput');
            const idInput = document.getElementById('idInput');
            const nameDisplay = document.getElementById('nameDisplay');
            const classDatalist = document.getElementById('classList');
            const idDatalist = document.getElementById('idList');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const retryButton = document.getElementById('retryButton');
            const homePage = document.getElementById('homePage');
            const homeName = document.getElementById('homeName');
            const logoutButton = document.getElementById('logoutButton');
            const cameraModal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const cameraStatus = document.getElementById('cameraStatus');
            const closeModalButton = document.getElementById('closeModalButton');
            
            // --- State Management ---
            let studentData = [];
            let currentStudent = null;
            let faceMatcher = null;
            let areModelsLoaded = false;
            let isVerifying = false; 

            // --- Session Management ---
            function checkForSavedSession() {
                const savedStudentJSON = localStorage.getItem('loggedInStudent');
                if (savedStudentJSON) {
                    try {
                        const student = JSON.parse(savedStudentJSON);
                        showHomePage(student);
                    } catch (e) {
                        console.error("Failed to parse saved student data", e);
                        localStorage.removeItem('loggedInStudent');
                        initializeLoginForm();
                    }
                } else {
                    initializeLoginForm();
                }
            }
            
            function initializeLoginForm() {
                loader.classList.remove('hidden');
                loader.querySelector('p').textContent = 'កំពុងទាញទិន្នន័យ...';
                Promise.all([loadModels(), fetchData()]);
            }

            function showHomePage(student) {
                loader.classList.add('hidden');
                appContainer.classList.add('hidden');
                homeName.textContent = student.name;
                homePage.classList.remove('hidden');
            }
            
            function logout() {
                localStorage.removeItem('loggedInStudent');
                homePage.classList.add('hidden');
                errorContainer.classList.add('hidden');
                accountForm.classList.remove('hidden');
                appContainer.classList.remove('hidden');
                // Reset form state
                classInput.value = '';
                idInput.value = '';
                idInput.disabled = true;
                idDatalist.innerHTML = '';
                nameDisplay.textContent = '-';
                currentStudent = null;
            }


            // --- Main Functions ---
            async function loadModels() {
                if (areModelsLoaded) return;
                console.log('Loading face recognition models...');
                try {
                    // MODIFICATION: Swapped to lighter models for performance
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                    console.log('Models loaded successfully.');
                    areModelsLoaded = true;
                } catch (error) {
                    console.error("Error loading models: ", error);
                    showError('បរាជ័យក្នុងការទាញយកម៉ូដែលវិភាគមុខ។');
                }
            }
            
            async function fetchData() {
                try {
                    const response = await fetch(URL);
                    if (!response.ok) throw new Error(`Network response error: ${response.status}`);
                    
                    const text = await response.text();
                    const jsonString = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                    const data = JSON.parse(jsonString);

                    if (data.status === 'error') throw new Error(data.errors.map(e => e.detailed_message).join(', '));

                    studentData = data.table.rows.map(row => {
                        if (!row || !row.c) return null;
                        const id = row.c[0]?.v;
                        const name = row.c[7]?.v;
                        const className = row.c[13]?.v;
                        let imageUrl = row.c[22]?.v;

                        if (imageUrl && imageUrl.includes('drive.google.com')) {
                           imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(imageUrl.replace('/file/d/', '/uc?export=view&id='))}`;
                        }
                        
                        if (id && name && className && imageUrl) {
                            return { id: String(id), name: String(name), class: String(className), imageUrl };
                        }
                        return null;
                    }).filter(Boolean);

                    populateClasses();
                    loader.classList.add('hidden');
                    accountForm.classList.remove('hidden');
                    appContainer.classList.remove('hidden');
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showError('បរាជ័យក្នុងការទាញទិន្នន័យពី Google Sheets។');
                }
            }
            
            function handleRetry() {
                errorContainer.classList.add('hidden');
                loader.classList.remove('hidden');
                loader.querySelector('p').textContent = 'កំពុងព្យាយាមម្ដងទៀត...';
                fetchData();
            }

            // --- UI Update Functions ---
            function populateClasses() {
                const uniqueClasses = [...new Set(studentData.map(item => item.class))];
                classDatalist.innerHTML = '';
                uniqueClasses.sort().forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    classDatalist.appendChild(option);
                });
            }

            function handleClassChange() {
                idDatalist.innerHTML = '';
                idInput.value = '';
                nameDisplay.textContent = '-';
                currentStudent = null;

                const filteredData = studentData.filter(item => item.class === classInput.value);
                if (filteredData.length > 0) {
                    filteredData.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        idDatalist.appendChild(option);
                    });
                    idInput.disabled = false;
                } else {
                    idInput.disabled = true;
                }
            }

            async function handleIdChange() {
                if (isVerifying) return;
                currentStudent = studentData.find(item => item.id === idInput.value);
                
                if (currentStudent) {
                    nameDisplay.textContent = currentStudent.name;
                    await startVerification();
                } else {
                    nameDisplay.textContent = '-';
                }
            }

            function showError(message) {
                loader.classList.add('hidden');
                appContainer.classList.remove('hidden');
                accountForm.classList.add('hidden');
                errorContainer.classList.remove('hidden');
                errorMessage.textContent = message;
            }

            // --- Face Verification Logic ---
            function stopCameraStream() {
                // MODIFICATION: No longer need to clear an interval
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                video.removeEventListener('play', onVideoPlay);
            }

            async function startVerification() {
                if (!currentStudent || !areModelsLoaded) return;
                
                isVerifying = true; 
                cameraModal.classList.remove('hidden');
                cameraStatus.textContent = 'កំពុងរៀបចំ...';
                
                try {
                    // MODIFICATION: Using TinyFaceDetector options
                    const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });
                    
                    cameraStatus.textContent = 'កំពុងដំណើរការរូបថតយោង...';
                    const referenceImage = await faceapi.fetchImage(currentStudent.imageUrl);
                    const referenceDetection = await faceapi.detectSingleFace(referenceImage, detectionOptions)
                        .withFaceLandmarks(true) // Use tiny landmark model
                        .withFaceDescriptor();
                    
                    if (!referenceDetection) throw new Error("រកមិនឃើញមុខនៅក្នុងរូបថតយោងទេ។");
                    
                    faceMatcher = new faceapi.FaceMatcher([referenceDetection.descriptor]);
                    cameraStatus.textContent = 'កំពុងស្នើសុំកាមេរ៉ា...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    video.srcObject = stream;
                    video.addEventListener('play', onVideoPlay);

                } catch (error) {
                    console.error("Verification Error:", error);
                    let userMessage = 'មានបញ្ហាក្នុងការបើកកាមេរ៉ា។';
                    if (error.name === 'NotReadableError' || (error.message && error.message.includes('Device in use'))) {
                        userMessage = 'កាមេរ៉ាកំពុងប្រើដោយកម្មវិធីផ្សេង។ សូមបិទកម្មវិធីនោះសិន។';
                    } else if (error.name === 'NotFoundError') {
                        userMessage = 'រកមិនឃើញកាមេរ៉ាទេ។ សូមប្រាកដថាបានភ្ជាប់រួចរាល់។';
                    } else if (error.name === 'NotAllowedError') {
                        userMessage = 'មិនមានការអនុញ្ញាតឱ្យប្រើកាមេរ៉ាទេ។ សូមពិនិត្យ Permission។';
                    } else if (error.message.includes("រកមិនឃើញមុខ")) {
                        userMessage = "បញ្ហារូបថត៖ រកមិនឃើញមុខក្នុងរូបថតដើមរបស់សិស្ស។";
                    }

                    cameraStatus.textContent = userMessage;
                    setTimeout(() => closeVerificationModal(true), 4000);
                }
            }

            // MODIFICATION: Replaced setInterval with a more efficient requestAnimationFrame loop
            async function onVideoPlay() {
                const displaySize = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(overlay, displaySize);
                const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });

                async function detectFace() {
                    if (!isVerifying) return; // Stop the loop if verification is cancelled

                    const detections = await faceapi.detectAllFaces(video, detectionOptions)
                        .withFaceLandmarks(true)
                        .withFaceDescriptors();
                    
                    overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);

                    if (detections.length > 0) {
                        const resizedDetections = faceapi.resizeResults(detections, displaySize);
                        const bestMatch = faceMatcher.findBestMatch(resizedDetections[0].descriptor);
                        const confidence = (1 - bestMatch.distance).toFixed(2);
                        cameraStatus.textContent = `កំពុងផ្ទៀងផ្ទាត់... (${confidence})`;
                        
                        if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) { 
                            verificationSuccess();
                        }
                    } else {
                        cameraStatus.textContent = 'រកមិនឃើញមុខ';
                    }
                    
                    requestAnimationFrame(detectFace); // Call the next frame
                }
                detectFace();
            }

            function verificationSuccess() {
                isVerifying = false; // Stop detection loop
                cameraStatus.textContent = 'ជោគជ័យ!';
                // Save session to localStorage
                localStorage.setItem('loggedInStudent', JSON.stringify(currentStudent));
                
                showHomePage(currentStudent);
                setTimeout(() => closeVerificationModal(false), 1000);
            }

            function closeVerificationModal(resetInputs = true) {
                isVerifying = false; // Ensure detection loop stops
                stopCameraStream();
                cameraModal.classList.add('hidden');
                
                if (resetInputs && idInput.value) {
                    idInput.value = '';
                    nameDisplay.textContent = '-';
                    currentStudent = null;
                }
            }
            
            // --- Event Listeners ---
            classInput.addEventListener('change', handleClassChange);
            idInput.addEventListener('change', handleIdChange);
            closeModalButton.addEventListener('click', () => closeVerificationModal(true));
            logoutButton.addEventListener('click', logout);
            retryButton.addEventListener('click', handleRetry);
            
            // --- Initial Load ---
            checkForSavedSession();
        });
    </script>

</body>
</html>

