<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីសម្គាល់អត្តសញ្ញាណ</title>
    <!-- Tailwind CSS សម្រាប់រចនាទំព័រ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js សម្រាប់វិភាគមុខ -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Google Fonts សម្រាប់ហ្វុងខ្មែរ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        /* រចនាប័ទ្មសម្រាប់ Loader ដែលបង្ហាញពេលកំពុងទាញទិន្នន័យ */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* រចនាប័ទ្មសម្រាប់ Modal បង្ហាញកាមេរ៉ា */
        #cameraModal {
            background-color: rgba(0, 0, 0, 0.6);
        }
        /* រចនាប័ទ្មសម្រាប់វីដេអូបង្ហាញក្នុងរង្វង់មូល */
        #videoContainer {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            background-color: #000;
            transform: scaleX(-1); /* បង្វិលវីដេអូដូចកញ្ចក់ */
        }
        #video, #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
        }
        /* រចនាប័ទ្មសម្រាប់ Scanner Effect */
        #scannerEffect {
            --scanner-color: #3b82f6;
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(
                from 180deg at 50% 50%,
                rgba(59, 130, 246, 0) 0%,
                var(--scanner-color) 50%,
                rgba(59, 130, 246, 0) 100%
            );
            animation: scanner-spin 2s linear infinite;
        }
        @keyframes scanner-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* រចនាប័ទ្មសម្រាប់បន្ទាត់ Laser ដែលរត់ចុះឡើង */
        #laserScanner {
            position: absolute;
            inset: 0.5rem;
            border-radius: 50%;
            overflow: hidden;
            pointer-events: none;
            z-index: 2;
        }
        #laserScanner::after {
            content: '';
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.8), 0 0 10px rgba(59, 130, 246, 0.8), 0 0 15px rgba(255, 255, 255, 0.8);
            animation: laser-scan-line 2.5s ease-in-out infinite;
        }
        @keyframes laser-scan-line {
            0% { left: 15%; }
            50% { left: 85%; }
            100% { left: 15%; }
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center min-h-screen p-4 sm:p-0 sm:items-center">

    <!-- ទម្រង់ចូល (លាក់ទុកដំបូង) -->
    <div id="appContainer" class="w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-6 hidden">
        <div id="formHeader" class="text-center">
            <h1 class="text-2xl font-bold text-gray-800">ទម្រង់ចូលគណនី</h1>
            <p class="text-gray-500 mt-2">សូមជ្រើសរើសព័ត៌មានរបស់អ្នក</p>
        </div>

        <form id="accountForm" class="space-y-6">
            <!-- ប្រអប់សម្រាប់ជ្រើសរើសថ្នាក់ -->
            <div id="classInputContainer">
                <label for="classInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើស ឬវាយបញ្ចូលថ្នាក់រៀន</label>
                <input list="classList" id="classInput" name="classInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                <datalist id="classList"></datalist>
            </div>

            <!-- ប្រអប់សម្រាប់ជ្រើសរើសអត្តលេខ -->
            <div id="idInputContainer">
                <label for="idInput" class="block text-sm font-medium text-gray-700 mb-1">ជ្រើសរើស ឬវាយបញ្ចូលអត្តលេខ</label>
                <input list="idList" id="idInput" name="idInput" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off" disabled>
                <datalist id="idList"></datalist>
            </div>

            <!-- កន្លែងបង្ហាញឈ្មោះ -->
            <div id="nameDisplayContainer" class="bg-gray-50 p-4 rounded-md text-center">
                <label class="text-sm font-medium text-gray-500">ឈ្មោះសិស្ស</label>
                <p id="nameDisplay" class="text-xl font-bold text-indigo-600 mt-1">-</p>
            </div>
        </form>
         <!-- កន្លែងបង្ហាញ Error -->
         <div id="errorContainer" class="text-center hidden">
             <p id="errorMessage" class="text-red-500"></p>
             <button id="retryButton" class="mt-4 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">ព្យាយាមម្ដងទៀត</button>
         </div>
    </div>
    
    <!-- Loader (បង្ហាញពេលដំបូង) -->
    <div id="loader" class="flex flex-col items-center justify-center space-y-2">
        <div class="loader"></div>
        <p class="text-gray-500">កំពុងរៀបចំ...</p>
    </div>

    <!-- NEW: Attendance Page (Replaces HomePage) -->
    <div id="attendancePage" class="w-full max-w-md bg-white rounded-lg shadow-xl p-8 space-y-4 text-center hidden">
        <h1 class="text-2xl font-bold text-gray-800">ប្រព័ន្ធកត់ត្រាវត្តមាន</h1>
        <p class="text-gray-600 text-lg">សូមស្វាគមន៍, <span id="attendanceName" class="font-bold"></span>!</p>

        <!-- Status Display -->
        <div id="statusContainer" class="bg-gray-100 p-3 rounded-md min-h-[40px] flex items-center justify-center">
            <p id="statusMessage" class="text-gray-700 font-medium">កំពុងរៀបចំ...</p>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 gap-4 pt-4">
            <button id="checkInButton" class="bg-green-500 text-white font-bold py-3 px-4 rounded-md hover:bg-green-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                Check In
            </button>
            <button id="checkOutButton" class="bg-orange-500 text-white font-bold py-3 px-4 rounded-md hover:bg-orange-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                Check Out
            </button>
        </div>

        <button id="logoutButton" class="mt-6 w-full bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600 transition-colors">ចាកចេញ</button>
    </div>


    <!-- Modal សម្រាប់ផ្ទៀងផ្ទាត់កាមេរ៉ា -->
    <div id="cameraModal" class="fixed inset-0 w-full h-full flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
            <h2 class="text-xl font-bold mb-4">សូមដាក់មុខនៅចំកណ្តាល</h2>
            <div class="relative w-64 h-64 mx-auto mb-4 p-2">
                <div id="scannerEffect"></div>
                <div id="laserScanner"></div>
                <div id="videoContainer">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
            </div>
            <p id="cameraStatus" class="text-gray-600 mb-4 h-6">កំពុងចាប់ផ្តើមកាមេរ៉ា...</p>
            <button id="closeModalButton" class="bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600">បោះបង់</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- ការកំណត់ค่า Configuration ---
            const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc'; // ID របស់ Google Sheet (បញ្ជីឈ្មោះ)
            const SHEET_NAME = 'DIList';
            const RANGE = 'E9:AI'; // បានពង្រីក Range ដើម្បីរួមបញ្ចូលកាលវិភាគ
            const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            
            // --- NEW: ការកំណត់សម្រាប់ Check-in/Check-out ---
            const LEAVE_SHEET_ID = '18oonwPyyU6I0hHX-vucvoYSqGf_S7wPnQX817CqauPE'; // ID របស់ Sheet (បញ្ជីច្បាប់)
            const LEAVE_SHEET_NAME = 'Requests';
            const CRB_LEAVE_SHEET_ID = '1xpy1CDg3LTD1iYPXKbfJrjldR5vVW3AhoNSwTzb8wDY'; // ID របស់ Sheet (បញ្ជីច្បាប់ CRB)
            const CRB_LEAVE_SHEET_NAME = 'CRBRequests';
            const TARGET_LAT = 11.414476639464848; // រយៈទទឹងគោលដៅ
            const TARGET_LON = 104.76383687139422; // រយៈបណ្តោយគោលដៅ
            const MAX_DISTANCE_METERS = 10; // រង្វង់អនុញ្ញាត (ម៉ែត្រ)

            // --- ការកំណត់ DOM Elements ---
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');
            const accountForm = document.getElementById('accountForm');
            const classInput = document.getElementById('classInput');
            const idInput = document.getElementById('idInput');
            const nameDisplay = document.getElementById('nameDisplay');
            const classDatalist = document.getElementById('classList');
            const idDatalist = document.getElementById('idList');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const retryButton = document.getElementById('retryButton');
            const cameraModal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const cameraStatus = document.getElementById('cameraStatus');
            const closeModalButton = document.getElementById('closeModalButton');
             // --- NEW: DOM Elements for Attendance Page ---
            const attendancePage = document.getElementById('attendancePage');
            const attendanceName = document.getElementById('attendanceName');
            const statusMessage = document.getElementById('statusMessage');
            const checkInButton = document.getElementById('checkInButton');
            const checkOutButton = document.getElementById('checkOutButton');
            const logoutButton = document.getElementById('logoutButton');

            
            // --- ការគ្រប់គ្រង State ---
            let studentData = [];
            let currentStudent = null;
            let faceMatcher = null;
            let areModelsLoaded = false;
            let isVerifying = false; 

            // --- ការគ្រប់គ្រង Session ---
            async function checkForSavedSession() {
                const savedStudentJSON = localStorage.getItem('loggedInStudent');
                if (savedStudentJSON) {
                    // Session exists, fetch fresh data before showing the page
                    loader.classList.remove('hidden');
                    loader.querySelector('p').textContent = 'កំពុងធ្វើបច្ចុប្បន្នភាពទិន្នន័យ...';
                    
                    try {
                        // Load models and data in parallel
                        await Promise.all([loadModels(), fetchData()]);

                        const studentFromLocal = JSON.parse(savedStudentJSON);
                        // Now that fetchData() has run, studentData is populated.
                        // Find the full student object from the fresh data.
                        const fullStudentObject = studentData.find(s => s.id === studentFromLocal.id);

                        if (fullStudentObject) {
                            // We found the student with their latest schedule. Proceed.
                            await showAttendancePage(fullStudentObject);
                        } else {
                            // The student is no longer in the sheet, treat as logged out.
                            console.log("Logged in user not found in current sheet. Logging out.");
                            logout();
                        }
                    } catch (e) {
                        // Corrupted local storage or fetch error
                        console.error("Failed to restore session:", e);
                        logout(); // Clear session and show login form
                    }
                } else {
                    // No session, normal login flow
                    initializeLoginForm();
                }
            }
            
            async function initializeLoginForm() {
                loader.classList.remove('hidden');
                loader.querySelector('p').textContent = 'កំពុងទាញទិន្នន័យ...';
                await Promise.all([loadModels(), fetchData()]);
            }

            // --- NEW: Function to show Attendance Page ---
            async function showAttendancePage(student) {
                loader.classList.add('hidden');
                appContainer.classList.add('hidden');
                errorContainer.classList.add('hidden');
                currentStudent = student; // រក្សាទុកข้อมูลសិស្សបច្ចុប្បន្ន

                attendanceName.textContent = student.name;
                attendancePage.classList.remove('hidden');

                await updateButtonStates(); // ហៅមុខងារថ្មីដើម្បីពិនិត្យស្ថានភាព
            }
            
            function logout() {
                localStorage.removeItem('loggedInStudent');
                attendancePage.classList.add('hidden');
                accountForm.classList.remove('hidden');
                appContainer.classList.remove('hidden');
                // កំណត់ទម្រង់ឡើងវិញ
                classInput.value = '';
                idInput.value = '';
                idInput.disabled = true;
                idDatalist.innerHTML = '';
                nameDisplay.textContent = '-';
                currentStudent = null;
            }


            // --- មុខងារចម្បង ---
            async function loadModels() {
                if (areModelsLoaded) return;
                try {
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                    areModelsLoaded = true;
                } catch (error) {
                    showError('បរាជ័យក្នុងការទាញយកម៉ូដែលវិភាគមុខ។');
                }
            }
            
            async function fetchData() {
                try {
                    const response = await fetch(URL);
                    if (!response.ok) throw new Error(`Network response error: ${response.status}`);
                    
                    const text = await response.text();
                    const jsonString = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                    const data = JSON.parse(jsonString);

                    if (data.status === 'error') throw new Error(data.errors.map(e => e.detailed_message).join(', '));

                    studentData = data.table.rows.map(row => {
                        if (!row || !row.c) return null;
                        const id = row.c[0]?.v;
                        const name = row.c[7]?.v;
                        const className = row.c[13]?.v;
                        let imageUrl = row.c[22]?.v;

                        if (imageUrl && imageUrl.includes('drive.google.com')) {
                           imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(imageUrl.replace('/file/d/', '/uc?export=view&id='))}`;
                        }
                        
                        if (id && name && className && imageUrl) {
                             // NEW: ទាញយកទិន្នន័យកាលវិភាគ
                            const schedule = {
                                mon: row.c[24]?.v, // AC = 24 (28-4)
                                tue: row.c[25]?.v, // AD = 25 (29-4)
                                wed: row.c[26]?.v, // AE = 26 (30-4)
                                thu: row.c[27]?.v, // AF = 27 (31-4)
                                fri: row.c[28]?.v, // AG = 28 (32-4)
                                sat: row.c[29]?.v, // AH = 29 (33-4)
                                sun: row.c[30]?.v, // AI = 30 (34-4)
                            };
                            return { id: String(id), name: String(name), class: String(className), imageUrl, schedule };
                        }
                        return null;
                    }).filter(Boolean);

                    populateClasses();
                    loader.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                } catch (error) {
                    showError('បរាជ័យក្នុងការទាញទិន្នន័យពី Google Sheets។');
                }
            }
            
            function handleRetry() {
                errorContainer.classList.add('hidden');
                accountForm.classList.remove('hidden');
                initializeLoginForm();
            }

            function populateClasses() {
                const uniqueClasses = [...new Set(studentData.map(item => item.class))];
                classDatalist.innerHTML = '';
                uniqueClasses.sort().forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    classDatalist.appendChild(option);
                });
            }

            function handleClassChange() {
                idDatalist.innerHTML = '';
                idInput.value = '';
                nameDisplay.textContent = '-';
                currentStudent = null;

                const filteredData = studentData.filter(item => item.class === classInput.value);
                if (filteredData.length > 0) {
                    filteredData.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        idDatalist.appendChild(option);
                    });
                    idInput.disabled = false;
                } else {
                    idInput.disabled = true;
                }
            }

            async function handleIdChange() {
                if (isVerifying) return;
                currentStudent = studentData.find(item => item.id === idInput.value);
                
                if (currentStudent) {
                    nameDisplay.textContent = currentStudent.name;
                    await startVerification();
                } else {
                    nameDisplay.textContent = '-';
                }
            }

            function showError(message) {
                loader.classList.add('hidden');
                appContainer.classList.add('hidden');
                attendancePage.classList.add('hidden');
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            }


            // --- ឡូហ្ស៊ិកផ្ទៀងផ្ទាត់មុខ ---
            function stopCameraStream() {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                video.removeEventListener('play', onVideoPlay);
            }

            async function startVerification() {
                if (!currentStudent || !areModelsLoaded) return;
                
                isVerifying = true; 
                cameraModal.classList.remove('hidden');
                cameraStatus.textContent = 'កំពុងរៀបចំ...';
                
                try {
                    const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });
                    
                    cameraStatus.textContent = 'កំពុងដំណើរការរូបថតយោង...';
                    const referenceImage = await faceapi.fetchImage(currentStudent.imageUrl);
                    const referenceDetection = await faceapi.detectSingleFace(referenceImage, detectionOptions)
                        .withFaceLandmarks(true)
                        .withFaceDescriptor();
                    
                    if (!referenceDetection) throw new Error("រកមិនឃើញមុខនៅក្នុងរូបថតយោងទេ។");
                    
                    faceMatcher = new faceapi.FaceMatcher([referenceDetection.descriptor]);
                    cameraStatus.textContent = 'កំពុងស្នើសុំកាមេរ៉ា...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    video.srcObject = stream;
                    video.addEventListener('play', onVideoPlay);

                } catch (error) {
                    let userMessage = 'មានបញ្ហាក្នុងការបើកកាមេរ៉ា។';
                    if (error.name === 'NotAllowedError') {
                        userMessage = 'មិនមានការអនុញ្ញាតឱ្យប្រើកាមេរ៉ាទេ។';
                    } else if (error.message.includes("រកមិនឃើញមុខ")) {
                        userMessage = "បញ្ហារូបថត៖ រកមិនឃើញមុខក្នុងរូបថតដើម។";
                    }
                    cameraStatus.textContent = userMessage;
                    setTimeout(() => closeVerificationModal(true), 4000);
                }
            }

            async function onVideoPlay() {
                if (!isVerifying) return;
                const displaySize = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(overlay, displaySize);
                const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });

                const detections = await faceapi.detectAllFaces(video, detectionOptions)
                    .withFaceLandmarks(true)
                    .withFaceDescriptors();
                
                if (detections.length > 0) {
                    const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
                    const confidence = ((1 - bestMatch.distance) * 100).toFixed(0);
                    cameraStatus.textContent = `កំពុងផ្ទៀងផ្ទាត់... (${confidence}%)`;
                    
                    if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) { 
                        verificationSuccess();
                        return;
                    }
                } else {
                    cameraStatus.textContent = 'រកមិនឃើញមុខ';
                }
                requestAnimationFrame(onVideoPlay);
            }

            function verificationSuccess() {
                isVerifying = false;
                cameraStatus.textContent = 'ជោគជ័យ!';
                localStorage.setItem('loggedInStudent', JSON.stringify(currentStudent));
                
                setTimeout(() => {
                  closeVerificationModal(false);
                  showAttendancePage(currentStudent);
                }, 1000);
            }

            function closeVerificationModal(resetInputs = true) {
                isVerifying = false;
                stopCameraStream();
                cameraModal.classList.add('hidden');
                
                if (resetInputs && idInput.value) {
                    idInput.value = '';
                    nameDisplay.textContent = '-';
                    currentStudent = null;
                }
            }
             // --- NEW: Functions for Attendance ---

            async function fetchLeaveDataFromSheet(sheetId, sheetName, studentId) {
                const LEAVE_URL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
                try {
                    const response = await fetch(LEAVE_URL);
                    if (!response.ok) throw new Error(`Network error for sheet ${sheetName}`);
                    
                    const text = await response.text();
                    const jsonString = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                    const data = JSON.parse(jsonString);

                    if (data.status === 'error') throw new Error(`API error for sheet ${sheetName}`);

                    const rows = data.table.rows;
                    // ជួរឈរ C គឺ index 2 (ID), ជួរឈរ G គឺ index 6 (Leave Status)
                    for (const row of rows) {
                        if (row.c && row.c[2]?.v == studentId) {
                            return row.c[6]?.v || null;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error(`Could not fetch leave data from ${sheetName}:`, error);
                    return 'FETCH_ERROR'; // Return a special string to indicate failure
                }
            }
            
            // NEW: មុខងារថ្មីសម្រាប់គ្រប់គ្រងស្ថានភាពប៊ូតុង
            async function updateButtonStates() {
                checkInButton.disabled = true;
                checkOutButton.disabled = true;
                statusMessage.textContent = 'កំពុងពិនិត្យកាលវិភាគ និងការសុំច្បាប់...';

                try {
                    // Fetch leave data from both sheets in parallel
                    const [leaveStatus, crbLeaveStatus] = await Promise.all([
                        fetchLeaveDataFromSheet(LEAVE_SHEET_ID, LEAVE_SHEET_NAME, currentStudent.id),
                        fetchLeaveDataFromSheet(CRB_LEAVE_SHEET_ID, CRB_LEAVE_SHEET_NAME, currentStudent.id)
                    ]);
                    
                    // Handle potential fetch errors
                    if (leaveStatus === 'FETCH_ERROR' || crbLeaveStatus === 'FETCH_ERROR') {
                        statusMessage.textContent = 'មិនអាចពិនិត្យមើលបញ្ជីច្បាប់បានទេ។';
                        return;
                    }

                    const schedule = currentStudent.schedule;

                    const now = new Date();
                    const dayOfWeek = now.getDay(); // 0=Sun, 1=Mon, ...
                    const dayMapping = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                    const todaySchedule = schedule[dayMapping[dayOfWeek]];
                    
                    let status = 'សូមស្វាគមន៍!';
                    let canCheckIn = false;
                    let canCheckOut = false;

                    // 1. Combine and check leave statuses
                    const cannotCheckIn = (leaveStatus === 'មួយព្រឹក' || leaveStatus === 'មួយថ្ងៃ') ||
                                          (crbLeaveStatus === 'មួយព្រឹក' || crbLeaveStatus === 'មួយថ្ងៃ' || crbLeaveStatus === 'ពេលយប់');

                    const cannotCheckOut = (leaveStatus === 'មួយរសៀល' || leaveStatus === 'មួយថ្ងៃ') ||
                                           (crbLeaveStatus === 'មួយរសៀល' || crbLeaveStatus === 'មួយថ្ងៃ' || crbLeaveStatus === 'ពេលយប់');
                    
                    if (cannotCheckIn && cannotCheckOut) {
                        status = 'អ្នកបានសុំច្បាប់មួយថ្ងៃ។';
                    } else {
                        const checkInAllowedByLeave = !cannotCheckIn;
                        const checkOutAllowedByLeave = !cannotCheckOut;
                        
                        // 2. Check schedule and time
                        const timeWindows = getTimeWindowsForSchedule(todaySchedule, dayOfWeek);
                        if (!timeWindows) {
                            status = 'ថ្ងៃនេះមិនមានកាលវិភាគទេ។';
                        } else {
                            const isCheckInTime = isTimeInWindow(now, timeWindows.checkInStart, timeWindows.checkInEnd);
                            const isCheckOutTime = isTimeInWindow(now, timeWindows.checkOutStart, timeWindows.checkOutEnd);

                            if (checkInAllowedByLeave && isCheckInTime) canCheckIn = true;
                            if (checkOutAllowedByLeave && isCheckOutTime) canCheckOut = true;

                            // Create status message
                            if (canCheckIn || canCheckOut) {
                                status = 'អ្នកអាច Check In ឬ Check Out បាន។';
                            } else if (!isCheckInTime && !isCheckOutTime) {
                                status = 'ក្រៅម៉ោងធ្វើការ។';
                            } else {
                                if (!checkInAllowedByLeave) status = 'អ្នកបានសុំច្បាប់ពេលព្រឹក។';
                                else if (!checkOutAllowedByLeave) status = 'អ្នកបានសុំច្បាប់ពេលរសៀល។';
                                else status = 'សូមពិនិត្យមើលម៉ោងធ្វើការរបស់អ្នក។';
                            }
                        }
                    }
                    
                    checkInButton.disabled = !canCheckIn;
                    checkOutButton.disabled = !canCheckOut;
                    statusMessage.textContent = status;

                } catch (error) {
                    statusMessage.textContent = 'មានបញ្ហាក្នុងការពិនិត្យស្ថានភាព។';
                    console.error("Error updating button states:", error);
                }
            }

            // NEW: មុខងារសម្រាប់កំណត់ម៉ោង Check-in/out តាមកាលវិភាគ
            function getTimeWindowsForSchedule(scheduleType, dayOfWeek) {
                const isFriday = dayOfWeek === 5;
                switch(scheduleType) {
                    case 'ពេញម៉ោង':
                        return {
                            checkInStart: '7:00AM', checkInEnd: '10:04AM',
                            checkOutStart: isFriday ? '3:15PM' : '5:30PM', checkOutEnd: '8:04PM'
                        };
                    case 'មួយព្រឹក':
                        return {
                            checkInStart: '7:00AM', checkInEnd: '10:04AM',
                            checkOutStart: '11:30AM', checkOutEnd: '1:04PM'
                        };
                    case 'មួយរសៀល':
                        return {
                            checkInStart: '11:00AM', checkInEnd: '1:44PM',
                            checkOutStart: isFriday ? '3:15PM' : '5:30PM', checkOutEnd: '8:04PM'
                        };
                    case 'ពេលយប់':
                        return {
                            checkInStart: '5:45PM', checkInEnd: '6:44PM',
                            checkOutStart: '8:55PM', checkOutEnd: '10:04PM'
                        };
                    default:
                        return null;
                }
            }

            // NEW: មុខងារជំនួយសម្រាប់ពិនិត្យមើលថាតើស្ថិតនៅក្នុងចន្លោះម៉ោងដែរឬទេ
            function isTimeInWindow(now, startStr, endStr) {
                const parseTime = (timeStr) => {
                    const date = new Date(now);
                    const [time, modifier] = timeStr.match(/(\d+:\d+)(AM|PM)/i).slice(1);
                    let [hours, minutes] = time.split(':').map(Number);
                    if (modifier.toUpperCase() === 'PM' && hours < 12) hours += 12;
                    if (modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
                    date.setHours(hours, minutes, 0, 0);
                    return date;
                };
                const startTime = parseTime(startStr);
                const endTime = parseTime(endStr);
                return now >= startTime && now <= endTime;
            }


            // NEW: មុខងារដែលត្រូវបានហៅនៅពេលចុចប៊ូតុង Check-in/out
            function handleAttendanceClick(type) {
                statusMessage.textContent = 'កំពុងស្នើសុំទីតាំង...';
                checkLocationAndProceed(type);
            }

            function checkLocationAndProceed(type) {
                if (!navigator.geolocation) {
                    statusMessage.textContent = 'កម្មវិធីរុករកមិនគាំទ្រទីតាំងភូមិសាស្ត្រទេ។';
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const distance = calculateDistance(TARGET_LAT, TARGET_LON, latitude, longitude);

                        if (distance <= MAX_DISTANCE_METERS) {
                            recordAttendance(type);
                        } else {
                            statusMessage.textContent = `អ្នកនៅឆ្ងាយពីទីតាំង (${distance.toFixed(0)}m)។`;
                        }
                    },
                    (error) => {
                        let msg = 'មិនអាចទទួលបានទីតាំងបច្ចុប្បន្នទេ។';
                        if (error.code === 1) msg = 'សូមអនុញ្ញាតឱ្យចូលប្រើទីតាំងរបស់អ្នក។';
                        statusMessage.textContent = msg;
                    }
                );
            }

            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // metres
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function recordAttendance(type) {
                statusMessage.textContent = `កំពុងដំណើរការ ${type}...`;
                // នៅក្នុងកម្មវិធីពិតប្រាកដ អ្នកនឹង Fetch POST request ទៅ Google Apps Script URL
                console.log(`ACTION: ${type} for student ${currentStudent.id} at ${new Date()}`);

                setTimeout(() => {
                    statusMessage.textContent = `${type} បានជោគជ័យ!`;
                    if (type === 'Check In') {
                        checkInButton.disabled = true;
                    } else { 
                        checkOutButton.disabled = true;
                    }
                }, 1500);
            }
            
            // --- Event Listeners ---
            classInput.addEventListener('change', handleClassChange);
            idInput.addEventListener('change', handleIdChange);
            closeModalButton.addEventListener('click', () => closeVerificationModal(true));
            retryButton.addEventListener('click', handleRetry);
             // --- NEW: Event Listeners for Attendance ---
            logoutButton.addEventListener('click', logout);
            checkInButton.addEventListener('click', () => handleAttendanceClick('Check In'));
            checkOutButton.addEventListener('click', () => handleAttendanceClick('Check Out'));
            
            // --- ចាប់ផ្តើមដំណើរការ ---
            checkForSavedSession();
        });
    </script>

</body>
</html>

